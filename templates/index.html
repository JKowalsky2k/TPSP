<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Wyniki zawodów</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="{{ url_for('static', filename='index.css') }}" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-light p-4">

<h1 class="mb-4" id="page-title" contenteditable="true" spellcheck="false" data-default="{{ default_page_title }}">{{ page_title }}</h1>

<div class="d-flex flex-wrap align-items-center gap-2 mb-4">
    <a href="/live" target="_blank" class="btn btn-primary">Tabela wyników (Na żywo)</a>
    <a href="{{ url_for('export_pdf', sort=sort, order=order) }}" class="btn btn-success">Export tabeli</a>
    <a href="/metrics-pdf" class="btn btn-secondary">Generacja metryk</a>
    <div class="btn-group" role="group" aria-label="Sortowanie kategorii">
        <a href="{{ url_for('index', sort='category_result', order='asc') }}"
           class="btn btn-outline-dark {% if sort == 'category_result' and order != 'desc' %}active{% endif %}">
            Kategorie A→Z, wynik malejąco
        </a>
    </div>
    <div class="form-check form-switch ms-auto">
        <input class="form-check-input" type="checkbox" id="dev-menu-toggle">
        <label class="form-check-label" for="dev-menu-toggle">Tryb deweloperski</label>
    </div>
    <button type="button" class="btn btn-outline-secondary ms-2" id="create-backup-button">
        Utwórz kopię zapasową
    </button>
    <button type="button" class="btn btn-warning ms-2" id="restore-backup-button">
        Przywróć dane
    </button>
    <button type="button" class="btn btn-danger ms-2" id="clear-table-button">
        Wyczyść tabelę
    </button>
    <button type="button" class="btn btn-dark ms-2" id="finish-competition-button">
        Zakończ zawody
    </button>
    <input type="file" id="restore-backup-input" accept=".json,application/json" style="display:none">
</div>

<div id="dev-tools" class="card border-secondary mb-4 d-none">
    <div class="card-body d-flex flex-wrap align-items-center gap-2">
        <strong class="text-secondary">Menu deweloperskie:</strong>
        <button type="button" class="btn btn-outline-secondary btn-sm" id="populate-example-data-button">
            Wypełnij przykładowymi danymi
        </button>
    </div>
</div>

<div class="table-responsive">
<table class="table table-striped table-hover table-bordered align-middle text-center" id="tabela">
<thead class="table-dark">
<tr>
{% for col in columns %}
    {% set th_class = '' %}
    {% if col.name == 'category' or col.name == 'parcour1' %}{% set th_class = 'col-gap-right' %}
    {% elif col.name == 'parcour4' or col.name == 'result' %}{% set th_class = 'col-gap-left' %}{% endif %}
    <th class="{{ th_class }} cursor-pointer">
        <a href="/?sort={{ col.name }}&order={% if sort==col.name and order=='asc' %}desc{% else %}asc{% endif %}" class="text-white text-decoration-none">
            {{ col.label }}
            {% if sort==col.name %}
                {% if order=='asc' %}↑{% else %}↓{% endif %}
            {% endif %}
        </a>
    </th>
{% endfor %}
</tr>
</thead>
<tbody>
{% for z in competitors %}
<tr x-data="{}" class="{{ 'group-even' if z.squad % 2 == 0 else 'group-odd' }}">
{% for col in columns %}
    {% set td_class = '' %}
    {% if col.name == 'category' or col.name == 'parcour1' %}{% set td_class = 'col-gap-right' %}
    {% elif col.name == 'parcour4' or col.name == 'result' %}{% set td_class = 'col-gap-left' %}{% endif %}
    {% if col.name == 'lastname' %}{% set td_class = td_class + ' lastname' %}{% endif %}
    {% if col.name.startswith('parcour') and getattr(z, col.name) == 25 %}{% set td_class = td_class + ' max-score' %}{% endif %}
    {% if col.name == 'category' %}
<td class="{{ td_class }}">
    <select class="form-select form-select-sm category-select"
    @change="
        fetch('/update',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({id:{{ z.id }}, field:'{{ col.name }}', value:$event.target.value})
        })
        .then(r=>r.json())
        .then(res=>{
            const row = $event.target.closest('tr');
            const cells = row.children;
            {% for c in columns %}
            {
                const cell = cells[{{ loop.index0 }}];
                if('{{ c.name }}' === 'category'){
                    const selectEl = cell.querySelector('select');
                    if(selectEl){
                        const newValue = res['{{ c.name }}'] || '';
                        if(newValue){
                            let hasOption = false;
                            for(const option of selectEl.options){
                                if(option.value === newValue){
                                    hasOption = true;
                                    break;
                                }
                            }
                            if(!hasOption){
                                const opt = document.createElement('option');
                                opt.value = newValue;
                                opt.textContent = newValue;
                                selectEl.appendChild(opt);
                            }
                        }
                        selectEl.value = newValue;
                    } else {
                        cell.textContent = res['{{ c.name }}'];
                    }
                } else {
                    cell.textContent = res['{{ c.name }}'];
                }

                if('{{ c.name }}'.startsWith('parcour') && res['{{ c.name }}'] == 25){
                    cell.classList.add('max-score');
                } else {
                    cell.classList.remove('max-score');
                }
            }
            {% endfor %}

            const g = parseInt(res.squad) || 1;
            row.className = (g%2==0)?'group-even':'group-odd';
        })">
        {% set allowed_categories = ['A', 'B', 'C', 'Junior', 'Lady', 'Senior'] %}
        {% set current_category = getattr(z, col.name) %}
        {% if current_category and current_category not in allowed_categories %}
        <option value="{{ current_category }}" selected>{{ current_category }}</option>
        {% endif %}
        {% for option in allowed_categories %}
        <option value="{{ option }}" {% if current_category == option %}selected{% endif %}>{{ option }}</option>
        {% endfor %}
    </select>
</td>
    {% else %}
<td class="{{ td_class }}" {% if col.name in editable_columns %} contenteditable {% endif %}
@blur="
    fetch('/update',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({id:{{ z.id }}, field:'{{ col.name }}', value:$el.innerText})
    })
    .then(r=>r.json())
    .then(res=>{
        const row = $el.parentNode;
        const cells = row.children;
        {% for c in columns %}
        {
            const cell = cells[{{ loop.index0 }}];
            if('{{ c.name }}' === 'category'){
                const selectEl = cell.querySelector('select');
                if(selectEl){
                    const newValue = res['{{ c.name }}'] || '';
                    if(newValue){
                        let hasOption = false;
                        for(const option of selectEl.options){
                            if(option.value === newValue){
                                hasOption = true;
                                break;
                            }
                        }
                        if(!hasOption){
                            const opt = document.createElement('option');
                            opt.value = newValue;
                            opt.textContent = newValue;
                            selectEl.appendChild(opt);
                        }
                    }
                    selectEl.value = newValue;
                } else {
                    cell.textContent = res['{{ c.name }}'];
                }
            } else {
                cell.textContent = res['{{ c.name }}'];
            }

            if('{{ c.name }}'.startsWith('parcour') && res['{{ c.name }}'] == 25){
                cell.classList.add('max-score');
            } else {
                cell.classList.remove('max-score');
            }
        }
        {% endfor %}

        const g = parseInt(res.squad) || 1;
        row.className = (g%2==0)?'group-even':'group-odd';
    })"
>
{{ getattr(z, col.name) }}
</td>
    {% endif %}
{% endfor %}
</tr>
{% endfor %}
</tbody>
</table>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const backupButton = document.getElementById("create-backup-button");
    if (backupButton) {
        backupButton.addEventListener("click", () => {
            backupButton.disabled = true;
            backupButton.classList.add("disabled");

            fetch("/backup", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
            })
                .then((response) => {
                    if (!response.ok) {
                        return response.json().catch(() => ({})).then((payload) => {
                            const message = payload && payload.message ? payload.message : "Nie udało się utworzyć kopii zapasowej.";
                            throw new Error(message);
                        });
                    }
                    return response.json();
                })
                .then((payload) => {
                    const backupInfo = payload && payload.backup ? `Kopia zapisana w ${payload.backup}` : "Kopia zapasowa została utworzona.";
                    alert(backupInfo);
                })
                .catch((error) => {
                    alert(error.message || "Nie udało się utworzyć kopii zapasowej.");
                })
                .finally(() => {
                    backupButton.disabled = false;
                    backupButton.classList.remove("disabled");
                });
        });
    }

    const finishButton = document.getElementById("finish-competition-button");
    if (finishButton) {
        finishButton.addEventListener("click", () => {
            if (!confirm("Czy na pewno chcesz zakończyć zawody i pobrać archiwum?")) {
                return;
            }

            finishButton.disabled = true;
            finishButton.classList.add("disabled");

            let redirected = false;
            fetch("/finish")
                .then((response) => {
                    if (response.redirected) {
                        redirected = true;
                        window.location.href = response.url;
                        return null;
                    }

                    if (!response.ok) {
                        return response
                            .text()
                            .then((message) => {
                                throw new Error(message || "Nie udało się zakończyć zawodów.");
                            });
                    }

                    const disposition = response.headers.get("Content-Disposition") || "";
                    return response.blob().then((blob) => ({ blob, disposition }));
                })
                .then((payload) => {
                    if (!payload) {
                        return;
                    }

                    const { blob, disposition } = payload;
                    let filename = "zawody.zip";
                    const match = /filename="?([^";]+)"?/i.exec(disposition);
                    if (match && match[1]) {
                        filename = match[1];
                    }

                    const url = window.URL.createObjectURL(blob);
                    const anchor = document.createElement("a");
                    anchor.href = url;
                    anchor.download = filename;
                    document.body.appendChild(anchor);
                    anchor.click();
                    anchor.remove();
                    window.URL.revokeObjectURL(url);
                })
                .catch((error) => {
                    if (error && error.message) {
                        alert(error.message === "" ? "Nie udało się zakończyć zawodów." : error.message);
                    } else {
                        alert("Nie udało się zakończyć zawodów.");
                    }
                })
                .finally(() => {
                    if (!redirected) {
                        finishButton.disabled = false;
                        finishButton.classList.remove("disabled");
                    }
                });
        });
    }

    const devToggle = document.getElementById("dev-menu-toggle");
    const devTools = document.getElementById("dev-tools");
    const populateButton = document.getElementById("populate-example-data-button");

    const syncDevMenuState = () => {
        if (!devTools) {
            return;
        }
        const enabled = devToggle ? devToggle.checked : false;
        devTools.classList.toggle("d-none", !enabled);
        if (populateButton) {
            populateButton.disabled = !enabled;
            populateButton.classList.toggle("disabled", !enabled);
        }
    };

    if (devToggle) {
        devToggle.addEventListener("change", syncDevMenuState);
    }
    syncDevMenuState();

    if (populateButton) {
        populateButton.addEventListener("click", () => {
            if (populateButton.disabled) {
                return;
            }
            if (!confirm("Czy na pewno nadpisać tabelę przykładowymi danymi?")) {
                return;
            }

            populateButton.disabled = true;
            populateButton.classList.add("disabled");

            fetch("/dev/populate", { method: "POST" })
                .then((response) => {
                    if (!response.ok) {
                        return response.json().catch(() => ({})).then((data) => {
                            const message =
                                data && data.message
                                    ? data.message
                                    : "Nie udało się wypełnić tabeli przykładowymi danymi.";
                            throw new Error(message);
                        });
                    }
                    return response.json();
                })
                .then((payload) => {
                    const message =
                        (payload && payload.message) ||
                        "Tabela została wypełniona przykładowymi danymi.";
                    alert(message);
                    window.location.reload();
                })
                .catch((error) => {
                    alert(
                        error && error.message
                            ? error.message
                            : "Nie udało się wypełnić tabeli przykładowymi danymi."
                    );
                })
                .finally(() => {
                    syncDevMenuState();
                });
        });
    }

    const restoreButton = document.getElementById("restore-backup-button");
    const restoreInput = document.getElementById("restore-backup-input");
    if (restoreButton && restoreInput) {
        restoreButton.addEventListener("click", () => {
            restoreInput.value = "";
            restoreInput.click();
        });

        restoreInput.addEventListener("change", () => {
            const fileList = restoreInput.files;
            if (!fileList || !fileList.length) {
                return;
            }

            const [file] = fileList;
            if (!file) {
                return;
            }

            restoreButton.disabled = true;
            restoreButton.classList.add("disabled");

            const formData = new FormData();
            formData.append("backup", file);

            fetch("/restore/upload", {
                method: "POST",
                body: formData,
            })
                .then((response) => {
                    if (!response.ok) {
                        return response.json().catch(() => ({})).then((data) => {
                            const message =
                                data && data.message
                                    ? data.message
                                    : "Nie udało się przywrócić danych z kopii zapasowej.";
                            throw new Error(message);
                        });
                    }
                    return response.json();
                })
                .then((payload) => {
                    if (payload && payload.message) {
                        alert(payload.message);
                    } else {
                        alert("Dane zostały przywrócone.");
                    }
                    window.location.reload();
                })
                .catch((error) => {
                    alert(error && error.message ? error.message : "Nie udało się przywrócić danych z kopii zapasowej.");
                })
                .finally(() => {
                    restoreButton.disabled = false;
                    restoreButton.classList.remove("disabled");
                    restoreInput.value = "";
                });
        });
    }

    const clearButton = document.getElementById("clear-table-button");
    if (clearButton) {
        clearButton.addEventListener("click", () => {
            if (!confirm("Czy na pewno chcesz wyczyścić wszystkie wpisy w tabeli?")) {
                return;
            }

            clearButton.disabled = true;
            clearButton.classList.add("disabled");

            fetch("/clear", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("Request failed");
                    }
                    return response.json();
                })
                .then((payload) => {
                    if (payload && payload.backup) {
                        alert(`Utworzono kopię zapasową: ${payload.backup}`);
                    }
                    window.location.reload();
                })
                .catch(() => {
                    clearButton.disabled = false;
                    clearButton.classList.remove("disabled");
                });
        });
    }

    const titleEl = document.getElementById("page-title");
    if (!titleEl) {
        return;
    }

    const defaultTitle = titleEl.dataset.default || "";
    let lastSavedTitle = titleEl.innerText.trim();

    const sanitizeTitle = (value) => {
        if (!value) {
            return "";
        }
        return value.split(/\s+/).join(" ").trim();
    };

    const commitTitleChange = () => {
        const rawTitle = sanitizeTitle(titleEl.innerText);
        const nextTitle = rawTitle || defaultTitle || lastSavedTitle;

        if (nextTitle !== rawTitle) {
            titleEl.innerText = nextTitle;
        }

        if (nextTitle === lastSavedTitle) {
            return;
        }

        fetch("/settings/title", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ title: nextTitle }),
        })
            .then((response) => response.json())
            .then((payload) => {
                if (payload && payload.page_title) {
                    lastSavedTitle = sanitizeTitle(payload.page_title) || defaultTitle;
                    titleEl.innerText = lastSavedTitle;
                }
            })
            .catch(() => {
                titleEl.innerText = lastSavedTitle;
            });
    };

    titleEl.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
            event.preventDefault();
            titleEl.blur();
        }
    });

    titleEl.addEventListener("blur", commitTitleChange);
});
</script>

</body>
</html>
